<p><strong>如何部署Django4.1项目</strong></p><h1>题外话</h1><h2>下载 docx 之后，要顺利发博客，还需要调整格式。</h2><p>√打开Styles Pane。</p><p><img src="1.png" /></p><p>√在文中定位一个式样后，把式样全选出来select all</p><p><strong><img src="2.png" /></strong></p><p>√apply 一个 word 的官方式样</p><p><strong><img src="3.png" /></strong></p><h2>要点:</h2><ul><li> √Ubuntu Server 20.04 LTS + Python 3.10.9 + Django 4.1.6</li><li>√Gunicorn: (Green unicorn) 作为 WSGI server</li><li>√Nginx:  as a reverse proxy server and static file server</li><li>√Supervisor: to manage Gunicorn processes</li></ul><h1>初始设置</h1><h2>准备清单:</h2><ul><li>√IP address of your server</li><li>√Username of the Ubuntu user account</li><li>√Password for the user account if you are using a password to connect to the server. Your cloud provider usually emails this to you.</li><li>√Key file if you are using key file instead of a password to connect to the server. Your cloud provider will ask you to download this before creating the server.</li></ul><h2>ssh 连接到服务器</h2><ul><li>√ssh your-username@your-server-ip-address</li><li>如果有秘钥文件, 则ssh your-username@your-server-ip-address -i path-to-your-key-file</li><li>如果文件不让访问, 则chmod 600 path-to-your-key-file</li><li>√sudo apt update</li></ul><h1>用 git下载源代码到服务器</h1><ul><li>√安装: sudo apt install git</li><li>√mkdir ~/projects</li><li>√cd ~/projects</li><li>现在还不能执行 git clone your-repository-url, 因为直接链接 https 链接的方式作废了, 要安装 git cli 才能 clone.</li><li>√用下面的行 1 和行 2 来安装git cli ↓</li></ul><table><tr><td><p>Bash<br /> type -p curl &gt;/dev/null || sudo apt install curl -y<br /> curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg &amp;&amp; sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg &amp;&amp; echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main&quot; | sudo tee /etc/apt/sources.list.d/github-cli.list &gt; /dev/null &amp;&amp; sudo apt update &amp;&amp; sudo apt install gh -y<br /> gh auth login # 装好后 login, 按照步骤认证机器</p></td></tr></table><ul><li>√行 3 用于验证和登录 ↑</li><li>√首次下载源代码: git clone https://github.com/ShuYi2023/mysite</li><li>将来代码更新后, 可以用 git pull origin master  拉取代码</li></ul><h1>安装Python</h1><ul><li>Ubuntu 20.04 默认的 Python 是 3.8 版本的.</li><li>√在 Ubuntu 20.04 系统中安装 python3.10</li></ul><table><tr><td><p>Bash<br />sudo add-apt-repository ppa:deadsnakes/ppa<br />sudo apt update<br />sudo apt install python3.10  # 会安装最新版的 3.10.9.<br /><br /># 安装 venv<br />sudo apt install python3.10-venv -y  # 3.10 不能省略<br /><br /># 如果要删除<br />sudo add-apt-repository --remove ppa:deadsnakes/ppa<br />sudo apt remove --autoremove python3.10</p></td></tr></table><h1>创建虚拟环境</h1><ul><li>√在终端输入下面的语句↓</li></ul><table><tr><td><p>Bash<br />max@ubserver:~$ mkdir envs  # 创建 /home/max/envs/<br />max@ubserver:~$ cd envs<br />max@ubserver:~/envs$ python3.10 -m venv dj4 # 创建虚拟环境dj4, 3.10 不能省略<br />max@ubserver:~/envs$ ls dj4/<br />max@ubserver:~/<strong>envs$ source /home/max/yenvs/dj4/bin/activate  # 激活虚拟环境</strong><br />(dj4)pip install -i https://pypi.mirrors.ustc.edu.cn/simple/ django # 安装 Django<br />(dj4)python -m  django --version # 查看 Django 版本, 4.1.6<br />(dj4)pip install -r requirements.txt  # 要先在本机用 freeze 做好requirements.txt</p></td></tr></table><ul><li>√用科大的源安装: pip install psycopg2-binary -i https://pypi.mirrors.ustc.edu.cn/simple/</li><li>pip 的时候, 科大的源比较快。</li><li>检查数据库是否有问题, √python manage.py migrate  </li></ul><h1>Nginx 安装</h1><ul><li>√sudo apt install nginx</li><li>√sudo rm -f /etc/nginx/sites-<strong>enabled</strong>/default</li><li>保险起见, 再删除一个default文件: √sudo rm -f /etc/nginx/sites-<strong>available</strong>/default</li><li>√创建配置文件: sudo nano /etc/nginx/sites-<strong>available</strong>/your_project_name ↓</li></ul><table><tr><td><p>Bash<br />server {<br />    listen 80;<br />    server_name _;<br /><br />    location / {<br />        include proxy_params;<br />        proxy_pass http://127.0.0.1:8000;<br />    }<br />}<br /></p></td></tr></table><ul><li>个人经验: 最好在本地用Pycharm创建和编辑配置文件, 然后把配置文件上传到服务器中. 参考↓</li></ul><p><img src="4.png" /></p><ul><li>第二部分↓</li></ul><p><img src="5.png" /></p><ul><li>√sudo ln -s /etc/nginx/sites-available/your_project_name /etc/nginx/sites-enabled/</li><li>检验: √sudo nginx -t</li><li>重启: √sudo systemctl restart nginx</li><li>访问ip, 如果报错 502, 则表明 Nginx 开始工作了</li><li>√激活虚拟环境, √cd 到项目根目录下.</li><li>启动服务器, √python manage.py runserver</li><li>Django mysite 应该能够正常工作了</li><li>√ctrl_c 关闭服务.</li></ul><h1>Gunicorn 设置</h1><ul><li>√安装: pip install gunicorn -i https://pypi.mirrors.ustc.edu.cn/simple/</li><li>√cd 到你项目的根目录</li><li>√用 gunicorn 启动服务: gunicorn your_project.wsgi  (例如, gunicorn mysite.wsgi)</li><li>√ctrl_c 关闭服务.</li><li>√让服务后台运行, 并且不受 logout 的影响: √gunicorn your_project.wsgi -D</li><li>√关闭在后台运行的 gunicorn: sudo pkill gunicorn</li></ul><h1>Supervisor 设置</h1><ul><li>Supervisor 能够在 Gunicorn 进程被终止后, 重启进程.</li><li>√安装: sudo apt install supervisor</li><li>√修改配置文件: sudo nano /etc/supervisor/conf.d/your_project.conf ↓</li></ul><table><tr><td><p>Bash<br />[program:mysite]<br />command = /home/max/yenvs/dj4/bin/gunicorn mysite.wsgi -b 127.0.0.1:8000 -w 3<br />directory = /home/max/mysite</p></td></tr></table><ul><li>↑在 command 中, 3=2*1(1 个核)+1, 其实我的 逻辑core =4, 是不是可以开 2*4+1=9 个线程?</li><li>√通知 supervisor 配置变化了: sudo supervisorctl reread</li><li>√更新: sudo supervisorctl update</li><li>√重启所有进程: sudo supervisorctl restart all</li></ul><h1>Serving Static and Media Files</h1><ul><li>这时网站中的静态文件还不能得到服务.</li><li>√修改 mystie.settings.py配置文件: STATIC_ROOT = os.path.join(BASE_DIR, 'static_root')</li><li>√在项目根目录 mysite 下面创建 static_root/ 目录</li></ul><p><img src="6.png" /></p><ul><li>√搜集静态文件: python manage.py collectstatic</li><li>√再次编辑 nginx 的配置文件: sudo nano /etc/nginx/sites-available/your_project_name ↓</li></ul><table><tr><td><p>Bash<br />server {<br />    listen 80;<br />    server_name _;<br /><br />    location / {<br />        include proxy_params;<br />        proxy_pass http://127.0.0.1:8000;<br />    }<br /><br />    location /static/ {<br />        root /home/your_ubuntu_username/projects/your_project/;<br />        add_header Pragma public;<br />        add_header Cache-Control &quot;public&quot;;<br />    }<br /><br />    location /media/ {<br />        root /home/your_ubuntu_username/projects/your_project/;<br />        add_header Pragma public;<br />        add_header Cache-Control &quot;public&quot;;<br />    }<br />}</p></td></tr></table><ul><li>√检查一下: sudo nginx -t</li><li>√重新启动 nginx: sudo systemctl restart nginx</li></ul><p>这时应该好了.</p><h1>注意事项</h1><p>安装gunicorn后, 访问网站<strong>不要提供 port.</strong></p><h2>直接访问 192.168.0.244 即可</h2>