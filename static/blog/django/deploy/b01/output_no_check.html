<p>b部署Django项目</p>

<h3>U410中mysite的文件夹 #flashcard</h3>

<ul>
<li>~/projects/mysite
<img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230930180521.png" alt="image.png|200" />
<!--ID: 1696068518959--></li>
</ul>

<h2>部署好之后的日常更新 #flashcard</h2>

<ul>
<li>√在本地写好文章后, 注入到本地的db.sqlite3</li>
<li>√用本地的db.sqlite3替换服务器中的db.sqlite3; 可以热替换
<ul>
<li>用Python脚本做这件事吧。开始可以用trz.</li>
</ul></li>
<li>√git ignore文件不再包含db.sqlite3</li>
<li>√部署的时候, 注意密码不要泄露
<!--ID: 1696075721909--></li>
</ul>

<h2>部署时的要点</h2>

<h3>整个系统的组成部分</h3>

<p><img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230930083345.png" alt="image.png|550" /></p>

<ul>
<li>Ubuntu Server 20.04 LTS + Python 3.10.9 + Django 4.1.6</li>
<li>Gunicorn: (Green unicorn) 作为 WSGI server</li>
<li>Nginx: as a reverse proxy server and static file server</li>
<li>Supervisor: to manage Gunicorn processes</li>
</ul>

<h2>准备清单</h2>

<ul>
<li>服务器的端口 22, 80, 8000 必须能用 √</li>
<li>获得服务器的IP地址
<ul>
<li>192.168.1.244 √</li>
</ul></li>
<li>服务器用户账号√, 密码√</li>
</ul>

<h2>ssh 连接到服务器</h2>

<ul>
<li>登入服务器</li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="c1"># 例如, maxyi_2017@192.168.1.244</span>
ssh<span class="w"> </span>your-username@your-server-ip-address<span class="w"> </span><span class="c1"># √</span>
<span class="c1"># 如果有秘钥文件, 则</span>
<span class="c1"># ssh your-username@your-server-ip-address -i path-to-your-key-file # √</span>
</code></pre>
</div>

<ul>
<li>如果秘钥文件不让访问, 则</li>
</ul>

<div class="codehilite">
<pre><span></span><code>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>path-to-your-key-file<span class="w"> </span><span class="c1"># √</span>
</code></pre>
</div>

<ul>
<li>更新一下apt并查看在远端文件夹的权限</li>
</ul>

<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="c1"># √</span>

<span class="c1"># 查看max在远程文件夹中的权限</span>
<span class="nb">cd</span><span class="w"> </span>/home/max<span class="w"> </span><span class="c1"># √</span>
ls<span class="w"> </span>-ld<span class="w"> </span>projects<span class="w"> </span><span class="c1"># √</span>
<span class="c1"># drwxrwxr-x 5 max max 前面的d表示这是dir, rwx 表示可读可写可执行 √</span>
</code></pre>
</div>

<h2>把本地文件夹上传到服务器</h2>

<ul>
<li>在终端输入命令: sftp max@192.168.1.xxx # 连接到服务器 √</li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="c1"># 上传文件夹: </span>
put<span class="w"> </span>-r<span class="w"> </span>/Users/maxmacboookpro2019/my_projs/10django_prjs/mysite<span class="w"> </span>/home/max/projects/<span class="w"> </span><span class="c1"># 上传本地的mysite文件夹到远端的projects文件夹之下 √</span>
</code></pre>
</div>

<ul>
<li>上传文件夹一定要有 -r (recursive)参数</li>
</ul>

<h2>(用git下载源代码到服务器)</h2>

<ul>
<li>安装git: </li>
</ul>

<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>git
mkdir<span class="w"> </span>~/projects<span class="w"> </span><span class="c1"># 创建目录</span>
<span class="nb">cd</span><span class="w"> </span>~/projects<span class="w"> </span><span class="c1"># 切换到目录</span>
</code></pre>
</div>

<ul>
<li><p>现在已经不能执行 git clone your-repository-url, 因为直接链接 https 链接的方式作废了, 要安装 git cli 才能 clone.</p></li>
<li><p>用下面的行 1 和行 2 来安装git cli, 行 3 用于验证和登录</p></li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="nb">type</span><span class="w"> </span>-p<span class="w"> </span>curl<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>curl<span class="w"> </span>-y

curl<span class="w"> </span>-fsSL<span class="w"> </span>https://cli.github.com/packages/githubcli-archive-keyring.gpg<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/usr/share/keyrings/githubcli-archive-keyring.gpg<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span>go+r<span class="w"> </span>/usr/share/keyrings/githubcli-archive-keyring.gpg<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [arch=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span><span class="s2"> signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/github-cli.list<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gh<span class="w"> </span>-y

gh<span class="w"> </span>auth<span class="w"> </span>login<span class="w"> </span><span class="c1"># 装好后 login, 按照步骤认证机器</span>
</code></pre>
</div>

<ul>
<li>首次下载源代码: </li>
</ul>

<div class="codehilite">
<pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ShuYi2023/mysite
</code></pre>
</div>

<ul>
<li>将来代码更新后, 可以用 </li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/mysite<span class="w"> </span><span class="c1"># 导航到项目目录</span>
git<span class="w"> </span>pull<span class="w"> </span><span class="c1"># 拉取代码</span>
</code></pre>
</div>

<h2>安装依赖包</h2>

<ul>
<li>在本地做好 requirements.txt
<ul>
<li>pip freeze &gt; reqs.txt # √</li>
</ul></li>
<li><p>在sftp窗口√, 上传 reqs.txt 到 远端的 /home/max/projects/mysite/ 下</p>

<ul>
<li>put /Users/maxmacboookpro2019/my_projs/10django_prjs/mysite/reqs.txt /home/max/projects/mysite/reqs.txt # √</li>
</ul></li>
<li><p>在终端输入下面的命令(这些命令是在服务器中执行的)</p></li>
</ul>

<div class="codehilite">
<pre><span></span><code>max@ubserver:~/envs$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>/home/max/yenvs/dj4/bin/activate<span class="w">  </span><span class="c1"># 激活虚拟环境 √</span>

<span class="o">(</span>dj4<span class="o">)</span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>reqs.txt<span class="w"> </span>-i<span class="w"> </span>https://pypi.mirrors.ustc.edu.cn/simple/<span class="w"> </span><span class="c1"># 安装依赖 √</span>
</code></pre>
</div>

<ul>
<li><p>用科大的源安装: pip install psycopg2-binary -i https://pypi.mirrors.ustc.edu.cn/simple/ # √</p></li>
<li><p>pip 的时候, 科大的源比较快。</p></li>
<li><p>检查数据库是否有问题, python manage.py migrate # √</p></li>
</ul>

<h2>Nginx 安装</h2>

<ul>
<li>安装和清理</li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="c1"># 在Ubuntu中安装nginx</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nginx<span class="w"> </span><span class="c1"># √</span>
<span class="c1"># 清理默认文件</span>
sudo<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-enabled/default<span class="w"> </span><span class="c1"># √</span>
<span class="c1"># 保险起见, 再删除一个default文件</span>
sudo<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-available/default<span class="w"> </span><span class="c1"># √</span>
<span class="c1"># 创建配置文件    </span>
sudo<span class="w"> </span>nano<span class="w"> </span>/etc/nginx/sites-available/your_project_name<span class="w"> </span><span class="c1"># √</span>
</code></pre>
</div>

<p><img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230929152034.png" alt="image.png|450" /></p>

<ul>
<li>编辑配置文件√</li>
</ul>

<div class="codehilite">
<pre><span></span><code>server<span class="w"> </span><span class="o">{</span>
<span class="w">    </span>listen<span class="w"> </span><span class="m">80</span><span class="p">;</span>
<span class="w">    </span>server_name<span class="w"> </span>_<span class="p">;</span>

<span class="w">    </span>location<span class="w"> </span>/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>include<span class="w"> </span>proxy_params<span class="p">;</span>
<span class="w">        </span>proxy_pass<span class="w"> </span>http://127.0.0.1:8000<span class="p">;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
<li><p>个人经验: 最好在本地用vscode或者Pycharm创建和编辑配置文件, 然后把配置文件上传到服务器中. 参考代码:
<img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230929152309.png" alt="image.png|550" />
<img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230929152346.png" alt="image.png|550" /></p></li>
<li><p>sudo ln -s /etc/nginx/sites-available/your_project_name /etc/nginx/sites-enabled/ # √</p></li>
<li><p>√检验: sudo nginx -t</p></li>
<li><p>重启: </p></li>
</ul>

<div class="codehilite">
<pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx<span class="w"> </span><span class="c1"># √</span>
</code></pre>
</div>

<ul>
<li>√访问ip, 如果报错 502, 则表明 Nginx 开始工作了</li>
<li>√cd 到项目根目录下.</li>
<li>激活虚拟环境</li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="nb">source</span><span class="w"> </span>/home/max/yenvs/dj4/bin/activate<span class="w"> </span><span class="c1"># √</span>
</code></pre>
</div>

<ul>
<li>√启动服务器, </li>
</ul>

<div class="codehilite">
<pre><span></span><code>python<span class="w"> </span>manage.py<span class="w"> </span>runserver<span class="w"> </span><span class="c1"># √</span>
</code></pre>
</div>

<ul>
<li><p>Django mysite 应该能够正常工作了</p></li>
<li><p>√ctrl_c 关闭服务.</p></li>
</ul>

<h2>Gunicorn 设置</h2>

<ul>
<li><p>√安装: pip install gunicorn -i https://pypi.mirrors.ustc.edu.cn/simple/</p></li>
<li><p>√cd 到你项目的根目录</p></li>
<li><p>√用 gunicorn 启动服务: gunicorn your_project.wsgi (例如, gunicorn mysite.wsgi)</p></li>
<li><p>√ctrl_c 关闭服务.</p></li>
<li><p>让服务后台运行, 并且不受 logout 的影响: </p>

<ul>
<li>gunicorn your_project.wsgi -D # √</li>
</ul></li>
<li><p>√关闭在后台运行的 </p>

<ul>
<li>gunicorn: sudo pkill gunicorn # √</li>
</ul></li>
</ul>

<h2>Supervisor 设置</h2>

<ul>
<li><p>Supervisor 能够在 Gunicorn 进程被终止后, 重启进程.</p></li>
<li><p>√安装: sudo apt install supervisor</p></li>
<li><p>√修改配置文件: sudo nano /etc/supervisor/conf.d/your_project.conf</p>

<ul>
<li>例如, sudo nano /etc/supervisor/conf.d/mysite.conf</li>
</ul></li>
</ul>

<div class="codehilite">
<pre><span></span><code><span class="o">[</span>program:mysite<span class="o">]</span>
<span class="nb">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/max/yenvs/dj4/bin/gunicorn<span class="w"> </span>mysite.wsgi<span class="w"> </span>-b<span class="w"> </span><span class="m">127</span>.0.0.1:8000<span class="w"> </span>-w<span class="w"> </span><span class="m">5</span>
<span class="nv">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/max/projects/mysite
</code></pre>
</div>

<ul>
<li><p>在 command 中, 3=2✖️2(1 个核)+1, 其实我的 逻辑core =4, 是不是可以开 2*4+1=9 个线程?</p></li>
<li><p>√通知 supervisor 配置变化了: sudo supervisorctl reread</p></li>
<li><p>√更新: sudo supervisorctl update</p></li>
<li><p>√重启所有进程: sudo supervisorctl restart all</p></li>
</ul>

<h2>Serving Static and Media Files</h2>

<ul>
<li><p>这时网站中的静态文件还不能得到服务.</p></li>
<li><p>√修改 mystie.settings.py配置文件: STATIC_ROOT = os.path.join(BASE_DIR, 'static_root')</p></li>
<li><p>√在项目根目录 mysite 下面创建 static_root/ 目录</p></li>
</ul>

<p><img src="https://maxobsidian.oss-cn-shanghai.aliyuncs.com/imgs/20230929153128.png" alt="image.png|450" /></p>

<ul>
<li><p>√搜集静态文件: python manage.py collectstatic</p></li>
<li><p>√再次编辑 nginx 的配置文件: sudo nano /etc/nginx/sites-available/your_project_name</p>

<ul>
<li>sudo nano /etc/nginx/sites-available/mysite_ng_config</li>
</ul></li>
</ul>

<div class="codehilite">
<pre><span></span><code>server<span class="w"> </span><span class="o">{</span>
<span class="w">    </span>listen<span class="w"> </span><span class="m">80</span><span class="p">;</span>
<span class="w">    </span>server_name<span class="w"> </span>_<span class="p">;</span>

<span class="w">    </span>location<span class="w"> </span>/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>include<span class="w"> </span>proxy_params<span class="p">;</span>
<span class="w">        </span>proxy_pass<span class="w"> </span>http://127.0.0.1:8000<span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span>location<span class="w"> </span>/static/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>root<span class="w"> </span>/home/your_ubuntu_username/projects/your_project/<span class="p">;</span>
<span class="w">        </span>add_header<span class="w"> </span>Pragma<span class="w"> </span>public<span class="p">;</span>
<span class="w">        </span>add_header<span class="w"> </span>Cache-Control<span class="w"> </span><span class="s2">&quot;public&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span>location<span class="w"> </span>/media/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>root<span class="w"> </span>/home/your_ubuntu_username/projects/your_project/<span class="p">;</span>
<span class="w">        </span>add_header<span class="w"> </span>Pragma<span class="w"> </span>public<span class="p">;</span>
<span class="w">        </span>add_header<span class="w"> </span>Cache-Control<span class="w"> </span><span class="s2">&quot;public&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
<li>√检查一下: sudo nginx -t</li>
<li>√重新启动 nginx: sudo systemctl restart nginx</li>
</ul>

<p>这时应该好了.</p>

<h2>注意事项</h2>

<ul>
<li>安装gunicorn后, 访问网站不要提供 port. 直接访问 192.168.1.244 即可 √</li>
<li>这样配置之后, 服务器开机就会自动启动网站</li>
<li>从局域网的另一台电脑访问 Django服务器: 192.168.1.244:8000 √</li>
<li>在Django项目的 setting.py 中设置好√</li>
</ul>

<pre><code>ALLOWED_HOSTS = ['*', 'localhost', '127.0.0.1', '192.168.0.244']
</code></pre>

<ul>
<li><p>√把修改好的配置文件上传到服务器</p></li>
<li><p>√启动服务器, 要给定 ip 和 端口 :</p>

<ul>
<li><code>(dj4)</code> <strong><code>max@u22</code></strong><code>:</code><strong><code>~/mysite</code></strong><code>$ python manage.py</code> <code>runserver 0.0.0.0:8000</code> # √</li>
<li>访问的时候, 要访问 <code>0.0.0.0:8000</code>, 不要写成 √ <code>0.0.0.0/8000</code>--折腾了 15 分钟</li>
<li>有了 gunicorn 后, 直接访问192.168.1.244即可, 后面不用写<code>:8000</code> .</li>
</ul></li>
</ul>
